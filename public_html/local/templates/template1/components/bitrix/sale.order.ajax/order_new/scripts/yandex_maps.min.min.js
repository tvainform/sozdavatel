BX.namespace("BX.Sale.OrderAjaxComponent.Maps");(function(){BX.Sale.OrderAjaxComponent.Maps={init:function(b){this.context=b||{};this.pickUpOptions=this.context.options.pickUpMap;this.propsOptions=this.context.options.propertyMap;this.maxWaitTimeExpired=false;return this},initializePickUpMap:function(b){if(!ymaps){return}this.pickUpMap=new ymaps.Map("pickUpMap",{center:!!b?[b.GPS_N,b.GPS_S]:[this.pickUpOptions.defaultMapPosition.lat,this.pickUpOptions.defaultMapPosition.lon],zoom:this.pickUpOptions.defaultMapPosition.zoom});this.pickUpMap.behaviors.disable("scrollZoom");this.pickUpMap.events.add("click",BX.delegate(function(){if(this.pickUpMap.balloon.isOpen()){this.pickUpMap.balloon.close()}},this))},pickUpMapFocusWaiter:function(){if(this.pickUpMap&&this.pickUpMap.geoObjects){this.setPickUpMapFocus()}else{setTimeout(BX.proxy(this.pickUpMapFocusWaiter,this),100)}},setPickUpMapFocus:function(){var e,f,d;e=this.pickUpMap.geoObjects.getBounds();if(e&&e.length){f=e[1][0]-e[0][0];d=e[1][1]-e[0][1];e[0][0]-=f/10;e[0][1]-=d/10;e[1][0]+=f/10;e[1][1]+=d/10;this.pickUpMap.setBounds(e,{checkZoomRange:true})}},showNearestPickups:function(h,f){if(!ymaps){return}var g=this.pickUpOptions.secureGeoLocation&&BX.browser.IsChrome()&&!this.context.isHttps?"yandex":"auto";var e=this.pickUpOptions.geoLocationMaxTime||5000;ymaps.geolocation.get({provider:g,timeOut:e}).then(BX.delegate(function(a){if(!this.maxWaitTimeExpired){this.maxWaitTimeExpired=true;a.geoObjects.options.set("preset","islands#darkGreenCircleDotIcon");this.pickUpMap.geoObjects.add(a.geoObjects);h(a)}},this),BX.delegate(function(){if(!this.maxWaitTimeExpired){this.maxWaitTimeExpired=true;f()}},this))},buildBalloons:function(f){if(!ymaps){return}var i=this;this.pickUpPointsJSON=[];for(var j=0;j<f.length;j++){var h=this.getStoreInfoHtml(f[j]);this.pickUpPointsJSON.push({type:"Feature",geometry:{type:"Point",coordinates:[f[j].GPS_N,f[j].GPS_S]},properties:{storeId:f[j].ID}});var g=new ymaps.Placemark([f[j].GPS_N,f[j].GPS_S],{hintContent:BX.util.htmlspecialchars(f[j].TITLE)+"<br />"+BX.util.htmlspecialchars(f[j].ADDRESS),storeTitle:f[j].TITLE,storeBody:h,id:f[j].ID,text:this.context.params.MESS_SELECT_PICKUP},{balloonContentLayout:ymaps.templateLayoutFactory.createClass('<h3>{{ properties.storeTitle }}</h3>{{ properties.storeBody|raw }}<br /><a class="btn btn-sm btn-default" data-store="{{ properties.id }}">{{ properties.text }}</a>',{build:function(){this.constructor.superclass.build.call(this);var a=document.querySelector("a[data-store]");if(a){BX.bind(a,"click",this.selectStoreByClick)}},clear:function(){var a=document.querySelector("a[data-store]");if(a){BX.unbind(a,"click",this.selectStoreByClick)}this.constructor.superclass.clear.call(this)},selectStoreByClick:function(a){var b=a.target||a.srcElement;if(i.pickUpMap.container.isFullscreen()){i.pickUpMap.container.exitFullscreen()}i.context.selectStore(b.getAttribute("data-store"));i.context.clickNextAction(a);i.pickUpMap.balloon.close()}})});if(BX("BUYER_STORE").value===f[j].ID){g.options.set("preset","islands#redDotIcon")}this.pickUpMap.geoObjects.add(g)}},selectBalloon:function(b){if(this.pickUpMap&&this.pickUpMap.geoObjects){this.pickUpMap.geoObjects.each(BX.delegate(function(a){if(a.properties.get("id")){a.options.unset("preset")}if(a.properties.get("id")===b){a.options.set({preset:"islands#redDotIcon"});this.pickUpMap.panTo([a.geometry.getCoordinates()])}},this))}},pickUpFinalAction:function(){if(this.pickUpMap&&this.pickUpMap.geoObjects){var b=BX("BUYER_STORE");this.pickUpMap.geoObjects.each(function(a){if(a.properties.get("id")===b.value){a.options.set({preset:"islands#redDotIcon"})}else{if(parseInt(a.properties.get("id"))>0){a.options.unset("preset")}}})}},initializePropsMap:function(b){if(!ymaps){return}this.propsMap=new ymaps.Map("propsMap",{center:[b.lat,b.lon],zoom:b.zoom});this.propsMap.behaviors.disable("scrollZoom");this.propsMap.events.add("click",BX.delegate(function(f){var e=f.get("coords"),a;if(this.propsMap.geoObjects.getLength()===0){a=new ymaps.Placemark([e[0],e[1]],{},{draggable:true,preset:"islands#redDotIcon"});a.events.add(["parentchange","geometrychange"],function(){var m=BX("orderDescription"),c=a.geometry.getCoordinates(),k,l,d,n;if(m){k=m.value.indexOf(BX.message("SOA_MAP_COORDS")+":");if(k===-1){m.value=BX.message("SOA_MAP_COORDS")+": "+c[0]+", "+c[1]+"\r\n"+m.value}else{n=BX.message("SOA_MAP_COORDS")+": "+c[0]+", "+c[1];l=m.value.substring(0,k);d=m.value.substring(k+n.length);m.value=l+n+d}}});this.propsMap.geoObjects.add(a)}else{this.propsMap.geoObjects.get(0).geometry.setCoordinates([e[0],e[1]])}},this))},canUseRecommendList:function(){return(this.pickUpPointsJSON&&this.pickUpPointsJSON.length)},getRecommendedStoreIds:function(n){if(!n){return[]}var j=[];var k=this.pickUpPointsJSON.length<this.pickUpOptions.nearestPickUpsToShow?this.pickUpPointsJSON.length:this.pickUpOptions.nearestPickUpsToShow;this.storeQueryResult={};for(var l=0;l<k;l++){var i=ymaps.geoQuery({type:"FeatureCollection",features:this.pickUpPointsJSON});var m=i.getClosestTo(n);var h=m.properties.get("storeId");this.storeQueryResult[h]=m;j.push(h);this.pickUpPointsJSON.splice(i.indexOf(m),1)}return j},getDistance:function(e,f){if(!e||!f){return false}var h=this.storeQueryResult[f];var g=ymaps.coordSystem.geo.getDistance(e.geometry.getCoordinates(),h.geometry.getCoordinates());g=Math.round(g/100)/10;return g},propsMapFocusWaiter:function(){},getStoreInfoHtml:function(d){var c="";if(d.ADDRESS){c+=BX.message("SOA_PICKUP_ADDRESS")+": "+BX.util.htmlspecialchars(d.ADDRESS)+"<br />"}if(d.PHONE){c+=BX.message("SOA_PICKUP_PHONE")+": "+BX.util.htmlspecialchars(d.PHONE)+"<br />"}if(d.SCHEDULE){c+=BX.message("SOA_PICKUP_WORK")+": "+BX.util.htmlspecialchars(d.SCHEDULE)+"<br />"}if(d.DESCRIPTION){c+=BX.message("SOA_PICKUP_DESC")+": "+BX.util.htmlspecialchars(d.DESCRIPTION)+"<br />"}return c}}})();