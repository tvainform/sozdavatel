BX.namespace("BX.Sale.OrderAjaxComponent.Maps");(function(){BX.Sale.OrderAjaxComponent.Maps={init:function(b){this.context=b||{};this.pickUpOptions=this.context.options.pickUpMap;this.propsOptions=this.context.options.propertyMap;this.maxWaitTimeExpired=false;this.scheme=this.context.isHttps?"https":"http";this.icons={red:this.scheme+"://maps.google.com/mapfiles/ms/icons/red-dot.png",green:this.scheme+"://maps.google.com/mapfiles/ms/icons/green-dot.png"};return this},initializePickUpMap:function(d){if(!google){return}this.markers=[];this.bounds=new google.maps.LatLngBounds();var f=!!d?parseFloat(BX.util.trim(d.GPS_N)):this.pickUpOptions.defaultMapPosition.lat,e=!!d?parseFloat(BX.util.trim(d.GPS_S)):this.pickUpOptions.defaultMapPosition.lon;this.pickUpMap=new google.maps.Map(BX("pickUpMap"),{center:{lat:f,lng:e},zoom:this.pickUpOptions.defaultMapPosition.zoom,scrollwheel:false});google.maps.event.addListener(this.pickUpMap,"click",BX.proxy(this.closeAllBalloons,this))},canUseRecommendList:function(){return false},getRecommendedStoreIds:function(d,c){return[]},getDistance:function(c,d){return false},pickUpMapFocusWaiter:function(){if(this.pickUpMap&&this.markers.length){this.setPickUpMapFocus()}else{setTimeout(BX.proxy(this.pickUpMapFocusWaiter,this),100)}},setPickUpMapFocus:function(){google.maps.event.trigger(this.pickUpMap,"resize");this.pickUpMap.fitBounds(this.bounds)},showNearestPickups:function(c,d){},buildBalloons:function(e){if(!google){return}var h,f;var g=this;for(h=0;h<e.length;h++){f=new google.maps.Marker({position:{lat:parseFloat(e[h].GPS_N),lng:parseFloat(e[h].GPS_S)},map:this.pickUpMap,title:e[h].TITLE});f.info=new google.maps.InfoWindow({content:"<h3>"+BX.util.htmlspecialchars(e[h].TITLE)+"</h3>"+this.getStoreInfoHtml(e[h])+'<br /><a class="btn btn-sm btn-default" data-store="'+e[h].ID+'">'+this.context.params.MESS_SELECT_PICKUP+"</a>"});f.storeId=e[h].ID;google.maps.event.addListener(f.info,"domready",function(){var a=document.querySelector("a[data-store]");if(a){BX.bind(a,"click",BX.proxy(g.selectStoreByClick,g))}});google.maps.event.addListener(f,"click",function(){g.closeAllBalloons();this.info.open(this.getMap(),this)});if(BX("BUYER_STORE").value===e[h].ID){f.setIcon(this.icons.green)}else{f.setIcon(this.icons.red)}this.markers.push(f);this.bounds.extend(f.getPosition())}},selectStoreByClick:function(c){var d=c.target||c.srcElement;this.context.selectStore(d.getAttribute("data-store"));this.context.clickNextAction(c);this.closeAllBalloons()},closeAllBalloons:function(){for(var b=0;b<this.markers.length;b++){this.markers[b].info.close()}},selectBalloon:function(d){if(!this.pickUpMap||!this.markers||!this.markers.length){return}for(var c=0;c<this.markers.length;c++){if(this.markers[c].storeId===d){this.markers[c].setIcon(this.icons.green);this.pickUpMap.panTo(this.markers[c].getPosition())}else{this.markers[c].setIcon(this.icons.red)}}},pickUpFinalAction:function(){},initializePropsMap:function(b){if(!google){return}this.propsMap=new google.maps.Map(BX("propsMap"),{center:{lat:b.lat,lng:b.lon},zoom:b.zoom,scrollwheel:false});this.currentPropsMapCenter=this.propsMap.getCenter();google.maps.event.addListener(this.propsMap,"click",BX.delegate(function(a){if(!this.propsMarker){this.propsMarker=new google.maps.Marker({position:a.latLng,map:this.propsMap,draggable:true});this.propsMarker.addListener("drag",BX.proxy(this.onPropsMarkerChanged,this));this.propsMarker.addListener("dragend",BX.proxy(this.onPropsMarkerChanged,this))}else{this.propsMarker.setPosition(a.latLng)}this.currentPropsMapCenter=a.latLng;this.onPropsMarkerChanged({latLng:a.latLng})},this))},onPropsMarkerChanged:function(o){var p=BX("orderDescription",true),l=o.latLng.lat(),i=o.latLng.lng(),m,n,k,j;if(p){m=p.value.indexOf(BX.message("SOA_MAP_COORDS")+":");if(m===-1){p.value=BX.message("SOA_MAP_COORDS")+": "+l+", "+i+"\r\n"+p.value}else{j=BX.message("SOA_MAP_COORDS")+": "+l+", "+i;n=p.value.substring(0,m);k=p.value.substring(m+j.length);p.value=n+j+k}}},propsMapFocusWaiter:function(){if(this.propsMap){this.setPropsMapFocus()}else{setTimeout(BX.proxy(this.propsMapFocusWaiter,this),100)}},setPropsMapFocus:function(){google.maps.event.trigger(this.propsMap,"resize");this.propsMap.setCenter(this.currentPropsMapCenter)},getStoreInfoHtml:function(d){var c="";if(d.ADDRESS){c+=BX.message("SOA_PICKUP_ADDRESS")+": "+BX.util.htmlspecialchars(d.ADDRESS)+"<br />"}if(d.PHONE){c+=BX.message("SOA_PICKUP_PHONE")+": "+BX.util.htmlspecialchars(d.PHONE)+"<br />"}if(d.SCHEDULE){c+=BX.message("SOA_PICKUP_WORK")+": "+BX.util.htmlspecialchars(d.SCHEDULE)+"<br />"}if(d.DESCRIPTION){c+=BX.message("SOA_PICKUP_DESC")+": "+BX.util.htmlspecialchars(d.DESCRIPTION)+"<br />"}return c}}})();