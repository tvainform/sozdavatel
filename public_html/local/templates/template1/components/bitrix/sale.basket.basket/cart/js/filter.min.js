(function(){BX.namespace("BX.Sale.BasketFilter");BX.Sale.BasketFilter=function(a){this.component=a;this.activeFilterMode=false;this.filterTimer=null;this.mouseOverClearFilter=false;this.realShownItems=[];this.realSortedItems=[];this.realScrollTop=0;this.lastShownItemsHash="";this.currentFilter={query:"",similarHash:"",warning:false,notAvailable:false,delayed:false};if(this.component.useItemsFilter){this.bindEvents()}};BX.Sale.BasketFilter.prototype.bindEvents=function(){var a;var b=this.component.getEntity(this.component.getCacheNode(this.component.ids.itemListWrapper),"basket-filter");a=this.component.getEntity(b,"basket-filter-input");if(BX.type.isDomNode(a)){BX.bind(a,"focus",function(){b.style.flex=3});BX.bind(a,"blur",BX.delegate(function(){if(!this.mouseOverClearFilter){b.style.flex=""}},this));BX.bind(a,"keyup",BX.proxy(this.onFilterInput,this));BX.bind(a,"cut",BX.proxy(this.onFilterInput,this));BX.bind(a,"paste",BX.proxy(this.onFilterInput,this))}a=this.component.getEntity(b,"basket-filter-clear-btn");if(BX.type.isDomNode(a)){BX.bind(a,"mouseenter",BX.delegate(function(){this.mouseOverClearFilter=true},this));BX.bind(a,"mouseout",BX.delegate(function(){this.mouseOverClearFilter=false},this));BX.bind(a,"click",BX.delegate(function(){if(!this.filterInputEmpty()){this.clearFilterInput();this.onFilterChange()}b.style.flex=""},this))}};BX.Sale.BasketFilter.prototype.isActive=function(){return this.activeFilterMode};BX.Sale.BasketFilter.prototype.showFilterByName=function(a){if(!a){return}switch(a){case"not-available":this.showNotAvailableItemsFilter();break;case"delayed":this.showDelayItemsFilter();break;case"warning":this.showWarningItemsFilter();break;case"similar":this.showSimilarItemsFilter();break;case"all":default:this.clearAllFiltersExcept([]);this.onFilterChange()}};BX.Sale.BasketFilter.prototype.onFilterInput=function(){var a=BX.type.isDomNode(BX.proxy_context)?BX.util.trim(BX.proxy_context.value).toLowerCase():"";if(this.currentFilter.query!==a){this.currentFilter.query=a;this.onFilterChange()}};BX.Sale.BasketFilter.prototype.clearAllFiltersExcept=function(a){if(!a||!BX.type.isArray(a)){return}!BX.util.in_array("input",a)&&this.clearFilterInput();!BX.util.in_array("warning",a)&&this.clearWarningItemsFilter();!BX.util.in_array("delayed",a)&&this.clearDelayItemsFilter();!BX.util.in_array("not-available",a)&&this.clearNotAvailableItemsFilter();if(!BX.util.in_array("similar",a)){this.clearSimilarItemsFilter();this.component.showSimilarCount(false)}};BX.Sale.BasketFilter.prototype.filterInputEmpty=function(){return this.currentFilter.query.length===0};BX.Sale.BasketFilter.prototype.clearFilterInput=function(){this.currentFilter.query="";var a=this.component.getEntity(this.component.getCacheNode(this.component.ids.itemListWrapper),"basket-filter-input");if(BX.type.isDomNode(a)){a.value=""}};BX.Sale.BasketFilter.prototype.addWarningItemsFilter=function(){this.currentFilter.warning=true};BX.Sale.BasketFilter.prototype.clearWarningItemsFilter=function(){this.currentFilter.warning=false};BX.Sale.BasketFilter.prototype.showWarningItemsFilter=function(){if(!this.currentFilter.warning){this.clearAllFiltersExcept(["warning"]);this.addWarningItemsFilter();this.onFilterChange()}};BX.Sale.BasketFilter.prototype.addDelayItemsFilter=function(){this.currentFilter.delayed=true};BX.Sale.BasketFilter.prototype.clearDelayItemsFilter=function(){this.currentFilter.delayed=false};BX.Sale.BasketFilter.prototype.showDelayItemsFilter=function(){if(!this.currentFilter.delayed){this.clearAllFiltersExcept(["delayed"]);this.addDelayItemsFilter();this.onFilterChange()}};BX.Sale.BasketFilter.prototype.addNotAvailableItemsFilter=function(){this.currentFilter.notAvailable=true};BX.Sale.BasketFilter.prototype.clearNotAvailableItemsFilter=function(){this.currentFilter.notAvailable=false};BX.Sale.BasketFilter.prototype.showNotAvailableItemsFilter=function(){if(!this.currentFilter.notAvailable){this.clearAllFiltersExcept(["not-available"]);this.addNotAvailableItemsFilter();this.onFilterChange()}};BX.Sale.BasketFilter.prototype.addSimilarItemsFilter=function(a){this.currentFilter.similarHash=a.HASH};BX.Sale.BasketFilter.prototype.clearSimilarItemsFilter=function(){this.currentFilter.similarHash=""};BX.Sale.BasketFilter.prototype.showSimilarItemsFilter=function(){var a=this.component.getItemDataByTarget(BX.proxy_context);if(this.currentFilter.similarHash!==a.HASH){this.clearAllFiltersExcept(["similar"]);this.addSimilarItemsFilter(a);this.onFilterChange()}};BX.Sale.BasketFilter.prototype.getTimeoutDuration=function(){return this.component.duration.filterTimer};BX.Sale.BasketFilter.prototype.onFilterChange=function(){this.component.showItemsOverlay();if(this.currentFilter.query.length||this.currentFilter.similarHash.length||this.currentFilter.warning||this.currentFilter.notAvailable||this.currentFilter.delayed){clearTimeout(this.filterTimer);this.filterTimer=setTimeout(BX.proxy(this.enableFilterMode,this),this.getTimeoutDuration())}else{this.disableFilterMode()}};BX.Sale.BasketFilter.prototype.enableFilterMode=function(){var a;if(!this.activeFilterMode){this.activeFilterMode=true;this.realShownItems=BX.util.array_values(this.component.shownItems);this.realSortedItems=BX.util.array_values(this.component.sortedItems);this.realScrollTop=this.component.getDocumentScrollTop()}this.component.scrollToFirstItem();this.component.sortedItems=this.searchItems();a=JSON.stringify(this.component.sortedItems);if(this.lastShownItemsHash!==a){this.lastShownItemsHash=a;this.component.deleteBasketItems(BX.util.array_values(this.component.shownItems),false);if(this.component.sortedItems.length){this.component.initializeBasketItems();this.hideEmptyFilterResult()}else{this.showEmptyFilterResult()}if(this.currentFilter.similarHash.length){this.component.showSimilarCount(true)}}else{this.highlightFoundItems()}this.component.hideItemsOverlay()};BX.Sale.BasketFilter.prototype.disableFilterMode=function(){clearTimeout(this.filterTimer);this.lastShownItemsHash="";if(this.activeFilterMode){this.activeFilterMode=false;this.component.sortedItems=BX.util.array_values(this.realSortedItems);this.component.deleteBasketItems(BX.util.array_values(this.component.shownItems),false);this.hideEmptyFilterResult();this.component.editBasketItems(BX.util.array_values(this.realShownItems));window.scrollTo(0,this.realScrollTop)}this.component.hideItemsOverlay()};BX.Sale.BasketFilter.prototype.searchItems=function(){var a=[];for(var b=0;b<this.realSortedItems.length;b++){var c=this.component.items[this.realSortedItems[b]];if(c&&this.searchItemMatch(c)){a.push(c.ID)}}return a};BX.Sale.BasketFilter.prototype.highlightFoundItems=function(){if(!this.activeFilterMode){return}for(var a in this.component.shownItems){if(this.component.shownItems.hasOwnProperty(a)){this.highlightSearchMatch(this.component.items[this.component.shownItems[a]])}}};BX.Sale.BasketFilter.prototype.searchItemMatch=function(d){var c=false,e=false;if(this.currentFilter.notAvailable){e=!!d.NOT_AVAILABLE;if(!e){return c}}else{if(this.currentFilter.delayed){e=!!d.DELAYED;if(!e){return c}}else{if(this.currentFilter.warning){e=BX.util.in_array(d.ID,this.component.warningItems);if(!e){return c}}else{if(BX.type.isNotEmptyString(this.currentFilter.similarHash)){e=this.currentFilter.similarHash===d.HASH;if(!e){return c}}}}}if(BX.type.isNotEmptyString(this.currentFilter.query)){if(d.NAME.toLowerCase().indexOf(this.currentFilter.query)!==-1){c="NAME"}if(!c){var f=parseFloat(this.currentFilter.query);if(!isNaN(f)){if(parseFloat(d.PRICE)===f){c="PRICE"}else{if(parseFloat(d.SUM_PRICE)===f){c="SUM_PRICE"}}}}if(!c&&this.currentFilter.query.length>=3){if(d.PRICE_FORMATED.toLowerCase().indexOf(this.currentFilter.query)!==-1){c="PRICE"}else{if(d.SUM_PRICE_FORMATED.toLowerCase().indexOf(this.currentFilter.query)!==-1){c="SUM_PRICE"}}}var b,a;if(!c&&d.PROPS.length){for(b in d.PROPS){if(d.PROPS.hasOwnProperty(b)){a=d.PROPS[b].VALUE.toLowerCase();if(a===this.currentFilter.query||(this.currentFilter.query.length>=3&&a.indexOf(this.currentFilter.query)!==-1)){c="PROPS";break}}}}if(!c&&d.COLUMN_LIST.length){for(b in d.COLUMN_LIST){if(d.COLUMN_LIST.hasOwnProperty(b)&&BX.type.isString(d.COLUMN_LIST[b].VALUE)){a=d.COLUMN_LIST[b].VALUE.toLowerCase();if(a===this.currentFilter.query||(this.currentFilter.query.length>=3&&a.indexOf(this.currentFilter.query)!==-1)){c="COLUMNS";break}}}}}else{if(e){c=true}}return c};BX.Sale.BasketFilter.prototype.highlightSearchMatch=function(a){var d=this.searchItemMatch(a);if(d){var c,e,b,f;switch(d){case"NAME":c=this.component.getEntity(BX(this.component.ids.item+a.ID),"basket-item-name");if(BX.type.isDomNode(c)){c.innerHTML=a.NAME.replace(new RegExp("(.*)("+this.currentFilter.query.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")+")(.*)","gi"),function(g,j,i,h){return BX.util.htmlspecialchars(j)+'<span class="basket-item-highlighted">'+BX.util.htmlspecialchars(i)+"</span>"+BX.util.htmlspecialchars(h)})}break;case"PRICE":c=BX(this.component.ids.price+a.ID);BX.addClass(c,"basket-item-highlighted");break;case"SUM_PRICE":c=BX(this.component.ids.sumPrice+a.ID);BX.addClass(c,"basket-item-highlighted");break;case"PROPS":c=this.component.getEntities(BX(this.component.ids.item+a.ID),"basket-item-property-value");for(e=0;e<c.length;e++){f=c[e].getAttribute("data-property-code");for(b in a.PROPS){if(a.PROPS.hasOwnProperty(b)&&a.PROPS[b].CODE===f){c[e].innerHTML=a.PROPS[b].VALUE.replace(new RegExp("("+this.currentFilter.query+")","gi"),'<span class="basket-item-highlighted">$1</span>')}}}break;case"COLUMNS":c=this.component.getEntities(BX(this.component.ids.item+a.ID),"basket-item-property-column-value");for(e=0;e<c.length;e++){f=c[e].getAttribute("data-column-property-code");for(b in a.COLUMN_LIST){if(a.COLUMN_LIST.hasOwnProperty(b)&&a.COLUMN_LIST[b].CODE===f){c[e].innerHTML=a.COLUMN_LIST[b].VALUE.replace(new RegExp("("+this.currentFilter.query+")","gi"),'<span class="basket-item-highlighted">$1</span>')}}}break}}};BX.Sale.BasketFilter.prototype.showEmptyFilterResult=function(){var b=this.component.getCacheNode(this.component.ids.itemList);if(BX.type.isDomNode(b)&&b.clientHeight>=500){var a=this.component.getCacheNode(this.component.ids.itemListEmptyResult);if(BX.type.isDomNode(a)){a.style.display=""}}};BX.Sale.BasketFilter.prototype.hideEmptyFilterResult=function(){var a=this.component.getCacheNode(this.component.ids.itemListEmptyResult);if(BX.type.isDomNode(a)){a.style.display="none"}}})();