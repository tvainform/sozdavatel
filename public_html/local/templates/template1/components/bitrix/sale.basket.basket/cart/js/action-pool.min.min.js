(function(){BX.namespace("BX.Sale.BasketActionPool");BX.Sale.BasketActionPool=function(a){this.component=a;this.requestProcessing=false;this.updateTimer=null;this.isBasketRefreshed=this.component.params.DEFERRED_REFRESH!=="Y";this.needFullRecalculation=this.component.params.DEFERRED_REFRESH==="Y";this.pool={};this.lastActualPool={};this.approvedAction=["QUANTITY","DELETE","RESTORE","DELAY","OFFER","MERGE_OFFER"];this.switchTimer()};BX.Sale.BasketActionPool.prototype.setRefreshStatus=function(a){this.isBasketRefreshed=!!a};BX.Sale.BasketActionPool.prototype.getRefreshStatus=function(){return this.isBasketRefreshed};BX.Sale.BasketActionPool.prototype.isItemInPool=function(a){return !!this.pool[a]};BX.Sale.BasketActionPool.prototype.clearLastActualQuantityPool=function(a){this.lastActualPool[a]&&delete this.lastActualPool[a].QUANTITY};BX.Sale.BasketActionPool.prototype.checkItemPoolBefore=function(a){if(!a){return}this.pool[a]=this.pool[a]||{}};BX.Sale.BasketActionPool.prototype.checkItemPoolAfter=function(a){if(!a||!this.pool[a]){return}if(Object.keys(this.pool[a]).length===0){delete this.pool[a]}};BX.Sale.BasketActionPool.prototype.addCoupon=function(a){this.pool.COUPON=a;this.switchTimer()};BX.Sale.BasketActionPool.prototype.removeCoupon=function(a){this.checkItemPoolBefore("REMOVE_COUPON");this.pool.REMOVE_COUPON[a]=a;this.switchTimer()};BX.Sale.BasketActionPool.prototype.changeQuantity=function(a,c,b){this.checkItemPoolBefore(a);if(this.lastActualPool[a]&&this.lastActualPool[a].QUANTITY!==c||!this.lastActualPool[a]&&c!==b){this.pool[a].QUANTITY=c}else{this.pool[a]&&delete this.pool[a].QUANTITY}this.checkItemPoolAfter(a);this.switchTimer()};BX.Sale.BasketActionPool.prototype.deleteItem=function(a){this.checkItemPoolBefore(a);if(this.pool[a].RESTORE){delete this.pool[a].RESTORE}else{this.pool[a].DELETE="Y"}this.checkItemPoolAfter(a);this.switchTimer()};BX.Sale.BasketActionPool.prototype.restoreItem=function(a,b){this.checkItemPoolBefore(a);if(this.pool[a].DELETE==="Y"){delete this.pool[a].DELETE}else{this.pool[a].RESTORE=b}this.checkItemPoolAfter(a);this.switchTimer()};BX.Sale.BasketActionPool.prototype.addDelayed=function(a){this.checkItemPoolBefore(a);this.pool[a].DELAY="Y";this.checkItemPoolAfter(a);this.switchTimer()};BX.Sale.BasketActionPool.prototype.removeDelayed=function(a){this.checkItemPoolBefore(a);this.pool[a].DELAY="N";this.checkItemPoolAfter(a);this.switchTimer()};BX.Sale.BasketActionPool.prototype.changeSku=function(a,c,b){if(JSON.stringify(c)!==JSON.stringify(b)){this.checkItemPoolBefore(a);this.pool[a].OFFER=c}else{this.pool[a]&&delete this.pool[a].OFFER;this.checkItemPoolAfter(a)}this.switchTimer()};BX.Sale.BasketActionPool.prototype.mergeSku=function(a){this.checkItemPoolBefore(a);this.pool[a].MERGE_OFFER="Y";this.switchTimer()};BX.Sale.BasketActionPool.prototype.switchTimer=function(){clearTimeout(this.updateTimer);if(this.isProcessing()){return}if(this.isPoolEmpty()){this.component.editPostponedBasketItems();this.component.fireCustomEvents()}if(!this.isPoolEmpty()){this.updateTimer=setTimeout(BX.proxy(this.trySendPool,this),300)}else{if(!this.getRefreshStatus()){this.trySendPool()}}};BX.Sale.BasketActionPool.prototype.trySendPool=function(){if(this.isPoolEmpty()&&this.getRefreshStatus()){return}this.doProcessing(true);if(!this.isPoolEmpty()){this.component.sendRequest("recalculateAjax",{basket:this.getPoolData()});this.lastActualPool=this.pool;this.pool={}}else{if(!this.getRefreshStatus()){this.component.sendRequest("refreshAjax",{fullRecalculation:this.needFullRecalculation?"Y":"N"});this.needFullRecalculation=false}}};BX.Sale.BasketActionPool.prototype.getPoolData=function(){var b={},d=this.pool;if(d.COUPON){b.coupon=d.COUPON;delete d.COUPON}if(d.REMOVE_COUPON){b.delete_coupon=d.REMOVE_COUPON;delete d.REMOVE_COUPON}for(var c in d){if(d.hasOwnProperty(c)){for(var a in d[c]){if(d[c].hasOwnProperty(a)&&BX.util.in_array(a,this.approvedAction)){b[a+"_"+c]=d[c][a]}}}}return b};BX.Sale.BasketActionPool.prototype.isPoolEmpty=function(){return Object.keys(this.pool).length===0};BX.Sale.BasketActionPool.prototype.doProcessing=function(a){this.requestProcessing=a===true;if(this.requestProcessing){this.component.startLoader()}else{this.component.endLoader()}};BX.Sale.BasketActionPool.prototype.isProcessing=function(){return this.requestProcessing===true}})();