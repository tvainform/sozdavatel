(function(){BX.namespace("BX.Sale.BasketActionPool");BX.Sale.BasketActionPool=function(a){this.component=a;this.requestProcessing=false;this.updateTimer=null;this.isBasketRefreshed=this.component.params.DEFERRED_REFRESH!=="Y";this.needFullRecalculation=this.component.params.DEFERRED_REFRESH==="Y";this.pool={};this.lastActualPool={};this.approvedAction=["QUANTITY","DELETE","RESTORE","DELAY","OFFER","MERGE_OFFER"];this.switchTimer()};BX.Sale.BasketActionPool.prototype.setRefreshStatus=function(a){this.isBasketRefreshed=!!a};BX.Sale.BasketActionPool.prototype.getRefreshStatus=function(){return this.isBasketRefreshed};BX.Sale.BasketActionPool.prototype.isItemInPool=function(a){return !!this.pool[a]};BX.Sale.BasketActionPool.prototype.clearLastActualQuantityPool=function(a){this.lastActualPool[a]&&delete this.lastActualPool[a].QUANTITY};BX.Sale.BasketActionPool.prototype.checkItemPoolBefore=function(a){if(!a){return}this.pool[a]=this.pool[a]||{}};BX.Sale.BasketActionPool.prototype.checkItemPoolAfter=function(a){if(!a||!this.pool[a]){return}if(Object.keys(this.pool[a]).length===0){delete this.pool[a]}};BX.Sale.BasketActionPool.prototype.addCoupon=function(a){this.pool.COUPON=a;this.switchTimer()};BX.Sale.BasketActionPool.prototype.removeCoupon=function(a){this.checkItemPoolBefore("REMOVE_COUPON");this.pool.REMOVE_COUPON[a]=a;this.switchTimer()};BX.Sale.BasketActionPool.prototype.changeQuantity=function(c,b,a){this.checkItemPoolBefore(c);if((this.lastActualPool[c]&&this.lastActualPool[c].QUANTITY!==b)||(!this.lastActualPool[c]&&b!==a)){this.pool[c].QUANTITY=b}else{this.pool[c]&&delete this.pool[c].QUANTITY}this.checkItemPoolAfter(c);this.switchTimer()};BX.Sale.BasketActionPool.prototype.deleteItem=function(a){this.checkItemPoolBefore(a);if(this.pool[a].RESTORE){delete this.pool[a].RESTORE}else{this.pool[a].DELETE="Y"}this.checkItemPoolAfter(a);this.switchTimer()};BX.Sale.BasketActionPool.prototype.restoreItem=function(b,a){this.checkItemPoolBefore(b);if(this.pool[b].DELETE==="Y"){delete this.pool[b].DELETE}else{this.pool[b].RESTORE=a}this.checkItemPoolAfter(b);this.switchTimer()};BX.Sale.BasketActionPool.prototype.addDelayed=function(a){this.checkItemPoolBefore(a);this.pool[a].DELAY="Y";this.checkItemPoolAfter(a);this.switchTimer()};BX.Sale.BasketActionPool.prototype.removeDelayed=function(a){this.checkItemPoolBefore(a);this.pool[a].DELAY="N";this.checkItemPoolAfter(a);this.switchTimer()};BX.Sale.BasketActionPool.prototype.changeSku=function(c,b,a){if(JSON.stringify(b)!==JSON.stringify(a)){this.checkItemPoolBefore(c);this.pool[c].OFFER=b}else{this.pool[c]&&delete this.pool[c].OFFER;this.checkItemPoolAfter(c)}this.switchTimer()};BX.Sale.BasketActionPool.prototype.mergeSku=function(a){this.checkItemPoolBefore(a);this.pool[a].MERGE_OFFER="Y";this.switchTimer()};BX.Sale.BasketActionPool.prototype.switchTimer=function(){clearTimeout(this.updateTimer);if(this.isProcessing()){return}if(this.isPoolEmpty()){this.component.editPostponedBasketItems();this.component.fireCustomEvents()}if(!this.isPoolEmpty()){this.updateTimer=setTimeout(BX.proxy(this.trySendPool,this),300)}else{if(!this.getRefreshStatus()){this.trySendPool()}}};BX.Sale.BasketActionPool.prototype.trySendPool=function(){if(this.isPoolEmpty()&&this.getRefreshStatus()){return}this.doProcessing(true);if(!this.isPoolEmpty()){this.component.sendRequest("recalculateAjax",{basket:this.getPoolData()});this.lastActualPool=this.pool;this.pool={}}else{if(!this.getRefreshStatus()){this.component.sendRequest("refreshAjax",{fullRecalculation:this.needFullRecalculation?"Y":"N"});this.needFullRecalculation=false}}};BX.Sale.BasketActionPool.prototype.getPoolData=function(){var a={},b=this.pool;if(b.COUPON){a.coupon=b.COUPON;delete b.COUPON}if(b.REMOVE_COUPON){a.delete_coupon=b.REMOVE_COUPON;delete b.REMOVE_COUPON}for(var d in b){if(b.hasOwnProperty(d)){for(var c in b[d]){if(b[d].hasOwnProperty(c)&&BX.util.in_array(c,this.approvedAction)){a[c+"_"+d]=b[d][c]}}}}return a};BX.Sale.BasketActionPool.prototype.isPoolEmpty=function(){return Object.keys(this.pool).length===0};BX.Sale.BasketActionPool.prototype.doProcessing=function(a){this.requestProcessing=a===true;if(this.requestProcessing){this.component.startLoader()}else{this.component.endLoader()}};BX.Sale.BasketActionPool.prototype.isProcessing=function(){return this.requestProcessing===true}})();